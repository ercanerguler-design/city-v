import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { useAdminStore } from '@/lib/stores/adminStore';
import { saveUser } from '@/lib/stores/userManager';

// √úyelik Tipleri
export type MembershipTier = 'free' | 'premium' | 'business' | 'enterprise';

export interface MembershipBenefits {
  tier: MembershipTier;
  features: {
    adFree: boolean;
    advancedAnalytics: boolean;
    aiChatLimit: number; // -1 = unlimited
    iotMonitoring: boolean;
    prioritySupport: boolean;
    customThemes: boolean;
    apiAccess: boolean;
    teamMembers: number;
  };
  price: {
    monthly: number;
    yearly: number;
  };
}

interface User {
  id: string;
  name: string;
  email: string;
  avatar?: string;
  membershipTier: MembershipTier;
  membershipExpiry?: Date | null; // null = lifetime/free
  aiCredits: number;
  createdAt: Date;
  
  // Premium √∂zellikleri i√ßin kolay eri≈üim
  get isPremium(): boolean;
  get isBusiness(): boolean;
  get isEnterprise(): boolean;
}

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  membershipBenefits: Record<MembershipTier, MembershipBenefits>;
  
  login: (email: string, password: string) => Promise<void>;
  loginWithGoogle: (googleUser: { email: string; name: string; picture?: string }) => Promise<void>;
  register: (name: string, email: string, password: string) => Promise<void>;
  logout: () => void;
  updateProfile: (data: Partial<User>) => void;
  upgradeToPremium: (plan: string) => void; // Eski sistem uyumluluƒüu
  upgradeMembership: (tier: MembershipTier, duration: 'monthly' | 'yearly') => void;
  checkFeatureAccess: (feature: keyof MembershipBenefits['features']) => boolean;
  getRemainingAICredits: () => number;
  useAICredit: () => boolean;
  createTestUser: (tier: MembershipTier) => void;
}

// @ts-ignore - Complex type inference with getters
export const useAuthStore = create<AuthState>()(
  persist(
    // @ts-ignore
    (set) => ({
      user: null,
      isAuthenticated: false,

      login: async (email: string, password: string) => {
        await new Promise((resolve) => setTimeout(resolve, 1000));
        
        // Kayƒ±tlƒ± kullanƒ±cƒ±larƒ± kontrol et
        const existingUsers = JSON.parse(localStorage.getItem('all-users-storage') || '{"users":[]}');
        const users = existingUsers.users || [];
        
        console.log('üîç Login denemesi:', email);
        console.log('üìä Storage\'da kayƒ±tlƒ± kullanƒ±cƒ± sayƒ±sƒ±:', users.length);
        
        // Kullanƒ±cƒ±yƒ± email ile bul
        const foundUser = users.find((u: any) => u.email === email);
        
        if (!foundUser) {
          console.log('‚ùå Kullanƒ±cƒ± bulunamadƒ±:', email);
          throw new Error('Bu email adresi ile kayƒ±tlƒ± kullanƒ±cƒ± bulunamadƒ±. L√ºtfen kayƒ±t olun.');
        }
        
        console.log('‚úÖ Kullanƒ±cƒ± bulundu:', foundUser.email, '- Tier:', foundUser.membershipTier);
        
        // Kullanƒ±cƒ± bulundu, giri≈ü yap
        const loggedInUser: any = {
          id: foundUser.id,
          name: foundUser.name,
          email: foundUser.email,
          avatar: foundUser.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(foundUser.name)}&background=6366f1&color=fff`,
          membershipTier: foundUser.membershipTier || 'free',
          membershipExpiry: foundUser.membershipExpiry || null,
          aiCredits: foundUser.aiCredits || 100,
          createdAt: foundUser.createdAt ? new Date(foundUser.createdAt) : new Date(),
          // Getter'lar i√ßin
          get isPremium() { return this.membershipTier !== 'free'; },
          get isBusiness() { return this.membershipTier === 'business'; },
          get isEnterprise() { return this.membershipTier === 'enterprise'; },
        };

        set({ user: loggedInUser, isAuthenticated: true });
        console.log('‚úÖ Login ba≈üarƒ±lƒ±, membershipTier:', loggedInUser.membershipTier);
      },

      loginWithGoogle: async (googleUser: { email: string; name: string; picture?: string }) => {
        await new Promise((resolve) => setTimeout(resolve, 500));
        
        // Kayƒ±tlƒ± kullanƒ±cƒ±larƒ± kontrol et
        const existingUsers = JSON.parse(localStorage.getItem('all-users-storage') || '{"users":[]}');
        const users = existingUsers.users || [];
        
        // Email ile kullanƒ±cƒ± var mƒ± kontrol et
        let foundUser = users.find((u: any) => u.email === googleUser.email);
        
        // Kullanƒ±cƒ± yoksa otomatik kaydet (Google ile ilk giri≈ü)
        if (!foundUser) {
          const newUser = {
            id: Date.now().toString(),
            name: googleUser.name,
            email: googleUser.email,
            avatar: googleUser.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(googleUser.name)}&background=6366f1&color=fff`,
            premium: false,
            membershipTier: 'free',
            createdAt: new Date().toISOString(),
            membershipExpiry: null,
            aiCredits: 100,
          };
          
          // Yeni kullanƒ±cƒ±yƒ± all-users-storage'a ekle
          users.push(newUser);
          localStorage.setItem('all-users-storage', JSON.stringify({ 
            users,
            lastUpdated: new Date().toISOString()
          }));
          foundUser = newUser;
          
          console.log('‚úÖ Google kullanƒ±cƒ±sƒ± all-users-storage\'a kaydedildi:', googleUser.email);
          console.log('üìä Toplam kullanƒ±cƒ± sayƒ±sƒ±:', users.length);
          
          // Admin paneline bildir
          try {
            const adminStore = useAdminStore.getState();
            adminStore.trackUserSignup(googleUser.name, newUser.id);
          } catch (error) {
            console.error('Admin tracking error:', error);
          }
        } else {
          console.log('‚úÖ Google kullanƒ±cƒ±sƒ± bulundu:', googleUser.email);
        }
        
        // Kullanƒ±cƒ± bulundu veya olu≈üturuldu, giri≈ü yap
        const loggedInUser: any = {
          id: foundUser.id,
          name: foundUser.name,
          email: foundUser.email,
          avatar: foundUser.avatar || googleUser.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(foundUser.name)}&background=6366f1&color=fff`,
          membershipTier: foundUser.membershipTier || 'free',
          membershipExpiry: foundUser.membershipExpiry || null,
          aiCredits: foundUser.aiCredits || 100,
          createdAt: foundUser.createdAt ? new Date(foundUser.createdAt) : new Date(),
          // Getter'lar i√ßin
          get isPremium() { return this.membershipTier !== 'free'; },
          get isBusiness() { return this.membershipTier === 'business'; },
          get isEnterprise() { return this.membershipTier === 'enterprise'; },
        };

        set({ user: loggedInUser, isAuthenticated: true });
        console.log('‚úÖ Google login ba≈üarƒ±lƒ±, membershipTier:', loggedInUser.membershipTier);
      },

      register: async (name: string, email: string, password: string) => {
        await new Promise((resolve) => setTimeout(resolve, 1000));
        
        // Email kontrol√º - zaten kayƒ±tlƒ± mƒ±?
        const existingUsers = JSON.parse(localStorage.getItem('all-users-storage') || '{"users":[]}');
        const users = existingUsers.users || [];
        
        if (users.find((u: any) => u.email === email)) {
          throw new Error('Bu email adresi zaten kayƒ±tlƒ±. L√ºtfen giri≈ü yapƒ±n.');
        }
        
        // Yeni kullanƒ±cƒ± olu≈ütur
        const newUserId = Date.now().toString();
        const newUserData = {
          id: newUserId,
          name,
          email,
          avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6366f1&color=fff`,
          premium: false,
          membershipTier: 'free' as MembershipTier,
          membershipExpiry: null,
          aiCredits: 50,
          createdAt: new Date().toISOString(),
        };
        
        // √ñNEMLƒ∞: √ñnce all-users-storage'a kaydet
        users.push(newUserData);
        localStorage.setItem('all-users-storage', JSON.stringify({ 
          users,
          lastUpdated: new Date().toISOString()
        }));
        
        console.log('‚úÖ Kullanƒ±cƒ± all-users-storage\'a kaydedildi:', email);
        console.log('üìä Toplam kullanƒ±cƒ± sayƒ±sƒ±:', users.length);
        
        // Sonra auth store'a set et
        const mockUser: any = {
          id: newUserId,
          name,
          email,
          avatar: newUserData.avatar,
          membershipTier: 'free' as MembershipTier,
          membershipExpiry: null,
          aiCredits: 50,
          createdAt: new Date(),
          // Getter'lar i√ßin
          get isPremium() { return this.membershipTier !== 'free'; },
          get isBusiness() { return this.membershipTier === 'business'; },
          get isEnterprise() { return this.membershipTier === 'enterprise'; },
        };

        set({ user: mockUser, isAuthenticated: true });
        
        // Admin paneline bildir
        try {
          const adminStore = useAdminStore.getState();
          adminStore.trackUserSignup(name, newUserId);
        } catch (error) {
          console.error('Admin tracking error:', error);
        }
      },

      logout: () => {
        set({ user: null, isAuthenticated: false });
      },

      updateProfile: (data: Partial<User>) => {
        set((state) => ({
          user: state.user ? { ...state.user, ...data } : null,
        }));
      },

      upgradeToPremium: (plan: string) => {
        // Eski sistem uyumluluƒüu - yeni sisteme y√∂nlendir
        const { user } = useAuthStore.getState();
        if (!user) return;
        
        const tierMap: Record<string, MembershipTier> = {
          'basic': 'premium',
          'pro': 'premium',
          'enterprise': 'enterprise'
        };
        const tier = tierMap[plan] || 'premium';
        
        const updatedUser: any = {
          ...user,
          membershipTier: tier,
          membershipExpiry: null,
          aiCredits: user.aiCredits + 100,
          get isPremium() { return this.membershipTier !== 'free'; },
          get isBusiness() { return this.membershipTier === 'business'; },
          get isEnterprise() { return this.membershipTier === 'enterprise'; },
        };
        
        set({ user: updatedUser });
      },

      createTestUser: (tier: MembershipTier) => {
        const isPremium = tier !== 'free';
        const testUser: any = {
          id: Date.now().toString(),
          name: isPremium ? `${tier.toUpperCase()} Test Kullanƒ±cƒ±sƒ±` : 'Free Test Kullanƒ±cƒ±sƒ±',
          email: isPremium ? `${tier}@test.com` : 'free@test.com',
          avatar: `https://ui-avatars.com/api/?name=${tier}&background=${isPremium ? 'fbbf24' : '6b7280'}&color=fff`,
          membershipTier: tier,
          membershipExpiry: null,
          aiCredits: isPremium ? 100 : 0,
          createdAt: new Date(),
          // Getter'lar
          get isPremium() { return this.membershipTier !== 'free'; },
          get isBusiness() { return this.membershipTier === 'business'; },
          get isEnterprise() { return this.membershipTier === 'enterprise'; },
        };

        set({ user: testUser, isAuthenticated: true });
      },

      // Membership benefits (bo≈ü d√∂nd√ºr ≈üimdilik)
      membershipBenefits: {} as Record<MembershipTier, MembershipBenefits>,

      // Feature access kontrol√º
      checkFeatureAccess: (feature: keyof MembershipBenefits['features']): boolean => {
        const state = useAuthStore.getState();
        const currentUser = state.user;
        if (!currentUser) return false;
        // Premium+ her ≈üeye eri≈üebilir
        return currentUser.membershipTier !== 'free';
      },

      // AI Credits
      getRemainingAICredits: () => {
        const user = useAuthStore.getState().user;
        return user?.aiCredits || 0;
      },

      useAICredit: () => {
        const { user } = useAuthStore.getState();
        if (!user || user.aiCredits <= 0) return false;
        set({ user: { ...user, aiCredits: user.aiCredits - 1 } });
        return true;
      },

      // Upgrade membership
      upgradeMembership: (tier: MembershipTier, duration: 'monthly' | 'yearly') => {
        const { user } = useAuthStore.getState();
        if (!user) return;
        
        const updatedUser: any = {
          ...user,
          membershipTier: tier,
          membershipExpiry: null, // Lifetime for now
          get isPremium() { return this.membershipTier !== 'free'; },
          get isBusiness() { return this.membershipTier === 'business'; },
          get isEnterprise() { return this.membershipTier === 'enterprise'; },
        };
        
        set({ user: updatedUser });
      },
    }),
    {
      name: 'auth-storage',
      storage: createJSONStorage(() => localStorage),
      // Persist'den sonra user objesini yeniden olu≈ütur (getter'larƒ± geri ekle)
      onRehydrateStorage: () => (state) => {
        if (state?.user) {
          const user = state.user as any;
          // Getter'larƒ± yeniden ekle
          Object.defineProperty(user, 'isPremium', {
            get() { return this.membershipTier !== 'free'; },
            enumerable: true
          });
          Object.defineProperty(user, 'isBusiness', {
            get() { return this.membershipTier === 'business'; },
            enumerable: true
          });
          Object.defineProperty(user, 'isEnterprise', {
            get() { return this.membershipTier === 'enterprise'; },
            enumerable: true
          });
        }
      }
    }
  )
);
